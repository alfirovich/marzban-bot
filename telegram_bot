<% TAGS [% %] %>

{{ MACRO getBotUsername BLOCK }}
    {{ 
        token = tpl.settings.telegram.token || config.telegram.token;
        getUsername = http.post("https://api.telegram.org/bot${token}/getMe").result.username; 
        getUsername; 

    }}
{{ END }}

{{
    # Get data from storage
    storageMessageType = user.id(1).storage.read('name', 'bot_configuration').messageType;
    storageMenuCmd = user.id(1).storage.read('name', 'bot_configuration').menuCmd;
    storageCheckNotPaidServices = user.id(1).storage.read('name', 'bot_configuration').checkNotPaidServices;
}}

{{  #   Global variables
    defaultMessageType = (storageMessageType || config.bot.defaultMessageType || 'sendMessage');
    mainMenuCmd = (storageMenuCmd || config.bot.mainMenuCmd || 'start');
    checkNotPaidServices = (storageCheckNotPaidServices == 0 ? 0 : storageCheckNotPaidServices == 1 ? 1 : config.bot.checkNotPaidServices ? config.bot.checkNotPaidServices : 0);
    supportUrl = (config.bot.supportUrl || 'https://t.me/durov');
    botUsername = (getBotUsername || config.bot.botUsername || tpl.settings.username || 'Set token or username in template settings or set username in config.bot.botUsername');
}}


{{ MACRO sendError BLOCK }}
    {
        "answerCallbackQuery": {
            "callback_query_id": {{ callback_query.id }},
            "parse_mode":"HTML",
            "text": "{{ errtext }}\nUserID: {{ user.user_id }}\n(( errcode: {{ code }} ))",
            "show_alert": true
        }
    },
    {
        "shmRedirectCallback": {
            "callback_data": "{{ mainMenuCmd }}"
        }
    }
    {{ STOP }}
{{ END }}

[%# Check for admin rights from user settings %]
[%# for use admin menu, set role = "admin" or "moderator" %]
{{ BLOCK checkAdminRights }}
    {{ IF user.settings.role != "admin" && user.settings.role != "moderator" }}
        {{ sendError(code=403, errtext='‚≠ïÔ∏è –†–∞–∑–¥–µ–ª –∑–∞–∫—Ä—ã—Ç') }}
    {{ END }}
{{ END }}

[%# Check for moderator rights %]
{{ MACRO checkModeratorRights BLOCK }}
    {{ IF user.settings.role == "moderator" && user.settings.moderate.$right != 1 }}
        {{ sendError(code=403, errtext="‚≠ïÔ∏è –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω!") }}
    {{ END }}
{{ END }}

[%# sendMessage or editMessageText functional %]
{{ MACRO send BLOCK }}
{{
    messageType =
        (cmd == '/start') ? 'sendMessage' :
        (cmd == 'menu' && mainMenuCmd == 'menu') ? 'editMessageText' :
        (mainMenuCmd == 'start' || cmd == 'start') ? 'sendMessage' :
        (defaultMessageType == 'editMessageText' ) ? 'editMessageText' :
        (edit == 1) ? 'editMessageText' :
        (!edit) ? 'sendMessage' :
        defaultMessageType;

    ret = user.set_settings({'state' => ''});
    IF user.settings.bot.reqPromo;
        delete(msgID=[user.settings.bot.reqPromo]);
        ret = user.set_settings({'bot' => {'reqPromo' => ''} });
    END;
}}


        {{ IF (cmd != '/start' && (!edit || edit == 0) && messageType != 'editMessageText' ) && cmd != 'sendMessage' }}
            {
                "deleteMessage": { "message_id": {{ message.message_id }} }
            },
        {{ END }}

    {{ # variable check for admin rights to admin menu
        IF admin == 1;
    }}
        {{ PROCESS checkAdminRights }}
    {{ END }}
    {
        "sendChatAction": {
            "chat_id": "{{ user.settings.telegram.chat_id }}",
            "action": "typing"
        }
    },
    {
        "{{messageType}}": {
            {{ IF messageType == 'editMessageText'}}
                "message_id": "{{ message.message_id }}",
            {{ END }}
            "parse_mode": "HTML",
            "text": "{{ TEXT.replace('\n','\n') }}",
            "reply_markup": {
                "inline_keyboard": [
                    {{ BUTTONS }}
                ]
            }
        }
    }
{{ END }}

{{ MACRO notification BLOCK }}
    {
        "sendMessage": {
            "parse_mode": "HTML",
            "text": "{{ TEXT.replace('\n','\n') }}",
            "reply_markup": {
            {{ IF force == 1 }}
                "force_reply": true,
            {{ END }}
            {{ IF BUTTONS }}
                "inline_keyboard": [
                    {{ BUTTONS }}
                ]
            {{ END }}
            }
        }
    }
{{ END }}

{{ MACRO delete BLOCK }}
{
    "deleteMessages": { "chat_id": {{ user.settings.telegram.chat_id }}, "message_ids": {{ toJson(msgID) }} }
},
{{ END }}

[%# MAIN LOGIC # %]
[% SWITCH cmd %]

[%# –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π %]
[% CASE 'USER_NOT_FOUND' %]
{
    "shmRegister": {
        "partner_id": "{{ start_args.partner_id }}",
        "callback_data": "/start",
        "error": "–û–®–ò–ë–ö–ê: –õ–æ–≥–∏–Ω {{ message.chat.username }} –∏–ª–∏ chat_id {{ message.chat.id }} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
    }
}


[%#   –û—Å–Ω–æ–≤–Ω–æ–µ / –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –±–æ—Ç–∞
    #   –ö–æ–º–∞–Ω–¥—ã:
    #       /start, start, menu

    #   –†–∞–∑–¥–µ–ª—ã –º–µ–Ω—é:
    #       admin:menu      - –º–µ–Ω—é –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    #       user:cabinet    - –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç
    #       user:keys       - –∫–ª—é—á–∏
    #       price           - –∫—É–ø–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É
    #       user:referrals  - —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞
    #       help            - –ø–æ–º–æ—â—å
%]
[% CASE ['/start', 'start', 'menu'] %]
{{   # variables
     messageType = (cmd == 'menu') ? 1 : 0;
}}


{{ TEXT = BLOCK }}
<b>–ú–µ–Ω—é —Å–∞–º–æ–≥–æ –ª—É—á—à–µ–≥–æ VPN –±–æ—Ç–∞</b>
{{ END }}

{{ BUTTONS = BLOCK }}
    {{ IF user.settings.role == 'moderator' || user.settings.role == 'admin'; }}
        [{ "text": "üë®‚Äçüíª –ú–µ–Ω—é {{ menuRole = (user.settings.role == 'admin' ? '–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞' : '–º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞'); menuRole; }}", "callback_data": "admin:menu" }],
    {{ END }}
    [{ "text": "üë§ –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç", "callback_data": "user:cabinet" }],
    [{ "text": "üõí –ö—É–ø–∏—Ç—å –∫–ª—é—á", "callback_data": "price" }],
    {{ IF user.us.has_services.size }}
        [{ "text": "üîë –ú–æ–∏ –∫–ª—é—á–∏", "callback_data": "user:keys" }],
    {{ END }}
    [{ "text": "ü§ù –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞", "callback_data": "user:referrals" }],
    [{ "text": "üõü –ü–æ–º–æ—â—å", "callback_data": "help" }]
{{ END }}
{{ send(TEXT=TEXT, BUTTONS=BUTTONS, edit=messageType)  }}


[%#   –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç %]
[% CASE ['user:cabinet'] %]
{{ TEXT = BLOCK }}
üë§ <b>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –ª—É—á—à–µ–≥–æ VPN –±–æ—Ç–∞</b>

UserID: {{ user.id }}
–ë–∞–ª–∞–Ω—Å: {{ user.balance }}‚ÇΩ
–ë–æ–Ω—É—Å—ã: {{ user.get_bonus }}‚ÇΩ

{{ IF user.discount }}
–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è —Å–∫–∏–¥–∫–∞: {{ user.discount }}%
{{ END }}
–ö–æ–ª-–≤–æ —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤: {{ user.referrals_count }}

<b>–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –æ–ø–ª–∞—Ç–∏—Ç—å:</b> {{ user.pays.forecast('blocked', 1).total }} ‚ÇΩ
{{ END }}

{{ BUTTONS = BLOCK }}
    [{ "text": "‚úö –ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å", "web_app": { "url": "{{ config.api.url }}/shm/v1/public/tg_payment?format=html&user_id={{ user.id }}" }}],
    [{ "text": "üè∑Ô∏è –í–≤–µ—Å—Ç–∏ –ø—Ä–æ–º–æ–∫–æ–¥", "callback_data": "promocode" }, { "text": "üè∑Ô∏è Web", "web_app": { "url": "{{ config.api.url }}/shm/v1/public/promo_webapp?format=html&user_id={{ user.id }}" }}],
    [{ "text": "‚ò∞ –ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π", "callback_data": "user:pays" }],
    [{ "text": "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", "callback_data": "{{ mainMenuCmd }}" }]
{{ END }}
{{ send(TEXT=TEXT, BUTTONS=BUTTONS) }}


[%  #   –ú–æ–∏ –∫–ª—é—á–∏ %]
[% CASE ['user:keys'] %]
{{ TEXT = BLOCK }}
üîë  <b>–°–ø–∏—Å–æ–∫ VPN –∫–ª—é—á–µ–π</b>
{{ END }}

{{ BUTTONS = BLOCK }}
    {{ FOR item IN user.us.items }}
        {{ SWITCH item.status }}
        {{ CASE 'ACTIVE' }}
            {{ icon = '‚úÖ' }}
            {{ status = '–†–∞–±–æ—Ç–∞–µ—Ç' }}
        {{ CASE 'BLOCK' }}
            {{ icon = '‚ùå' }}
            {{ status = '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞' }}
        {{ CASE 'NOT PAID' }}
            {{ icon = 'üíµ' }}
            {{ status = '–û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã' }}
        {{ CASE }}
            {{ icon = '‚è≥' }}
            {{ status = '–û–±—Ä–∞–±–æ—Ç–∫–∞' }}
        {{ END }}

        [
            {
                "text": "‚Ññ{{ item.user_service_id }} - {{ item.name }} - {{ icon }} {{ status }}",
                "callback_data": "user:keys:id {{ item.user_service_id }}"
            }
        ],
    {{ END }}
    [
        {
            "text": "‚úö –ö—É–ø–∏—Ç—å –Ω–æ–≤—ã–π –∫–ª—é—á",
            "callback_data": "price"
        }
    ],
    [
        {
            "text": "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é",
            "callback_data": "{{ mainMenuCmd }}"
        }
    ]
{{ END }}
{{ send(TEXT=TEXT, BUTTONS=BUTTONS) }}


[%  #   –ú–µ–Ω—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–ª—é—á–µ
    #   args.0 - id —É—Å–ª—É–≥–∏
%]
[% CASE ['user:keys:id'] %]
{{ # Variables
    us = user.services.list_for_api('usi', args.0);

    # Plugins
    USE date;
}}

{{
    SWITCH us.status;
        CASE 'ACTIVE';
            icon = '‚úÖ';
            status = '–ê–∫—Ç–∏–≤–µ–Ω';
        CASE 'BLOCK';
            icon = '‚ùå';
            status = '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω';
        CASE 'NOT PAID';
            icon = 'üíµ';
            status = '–û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—É';
        CASE;
            icon = '‚è≥';
            status = '–û–±—Ä–∞–±–æ—Ç–∫–∞';
    END;
}}

{{ TEXT = BLOCK }}
üîë <b>–ö–ª—é—á #{{ us.user_service_id }} - {{ us.name }}</b>

{{ IF us.expire }}
üóìÔ∏è <b>–û–ø–ª–∞—á–µ–Ω –¥–æ</b>: {{ date.format(us.expire, '%d.%m.%Y') }}
{{ END }}
<b>–°—Ç–∞—Ç—É—Å</b>: {{ icon }} {{ status }}
{{ IF us.next != us.service_id && us.next > 0 }}
<b>–°–ª–µ–¥—É—é—â–∏–π —Ç–∞—Ä–∏—Ñ –∫–ª—é—á–∞</b>: {{ service.id(us.next).name }}
{{ END }}
{{ END }}

{{ BUTTONS = BLOCK }}
  {{ IF us.status == 'ACTIVE' }}
    {{ subscription_url = storage.read('name', 'vpn_mrzb_' _ us.user_service_id).subscription_url }}
    {{ IF us.category.grep('^vpn-mz-').first && subscription_url.grep('^https:').first }}
      [
        {
          "text": "üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è",
          "web_app": {
            "url": "{{ subscription_url }}"
          }
        }
      ],
      [
        {
          "text": "üåê –ü–æ–∫–∞–∑–∞—Ç—å —Å—Å—ã–ª–∫—É –ø–æ–¥–ø–∏—Å–∫–∏",
          "callback_data": "user:keys:show {{ us.user_service_id }}"
        }
      ],
    {{ ELSE }}
      [
        {
          "text": "üò¢ –û—à–∏–±–∫–∞: –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ",
          "callback_data": "{{ mainMenuCmd }}"
        },
        {
          "text": "Maybe Marzban not connected",
          "callback_data": "{{ mainMenuCmd }}"
        }
      ],
    {{ END }}
  {{ ELSIF us.status == ('NOT PAID' || 'BLOCK') }}
    [
        {
        "text": "üí∞ –û–ø–ª–∞—Ç–∏—Ç—å",
        "callback_data": "user:cabinet"
        }
    ],
    [
        {
            "text": "üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∫–ª—é—á",
            "callback_data": "user:keys:delete {{ us.user_service_id }}"
        }
    ],
  {{ END }}
    [
        {
            "text": "‚ôªÔ∏è –°–º–µ–Ω–∏—Ç—å —Å–ª–µ–¥. —Ç–∞—Ä–∏—Ñ",
            "callback_data": "user:keys:next {{ us.user_service_id }}"
        }
    ],
    [
        {
            "text": "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é",
            "callback_data": "{{ mainMenuCmd }}"
        }
    ]
{{ END }}
{{ send(TEXT=TEXT, BUTTONS=BUTTONS) }}


[%  #   –ú–µ–Ω—é —Å–º–µ–Ω—ã —Å–ª–µ–¥. —Ç–∞—Ä–∏—Ñ–∞ %]
[% CASE ['user:keys:next', 'user:keys:next:confirm'] %]
{{ 
    # Variables
    usi = user.services.list_for_api('usi', args.0);

    # Plugins
    USE date;
}}

{{ 
    IF cmd == 'user:keys:next:confirm';
        us = us.id(args.0)
        ret = us.set("next", args.1);
}}
{
    "answerCallbackQuery": {
         "callback_query_id": {{ callback_query.id }},
         "parse_mode":"HTML",
         "text": "‚úÖ –°–ª–µ–¥—É—é—â–∏–π —Ç–∞—Ä–∏—Ñ —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ {{ service.id(args.1).name }}",
         "show_alert": true
     }
},
{
    "shmRedirectCallback": {
        "callback_data": "user:keys:id {{ usi.user_service_id }}"
    }
}
{{ STOP }}
{{ END }}

{{ TEXT = BLOCK }}
‚ÑπÔ∏è –°–º–µ–Ω–∞ —Ç–∞—Ä–∏—Ñ–∞ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –ø—Ä–æ–¥–ª–µ–Ω–∏–∏ –∫–ª—é—á–∞

<b>–î–∞—Ç–∞ —Å–ª–µ–¥. –ø—Ä–æ–¥–ª–µ–Ω–∏—è</b>: {{ date.format(usi.expire, '%d.%m.%Y') }}
<b>–¢–µ–∫—É—â–∏–π —Ç–∞—Ä–∏—Ñ</b>: {{ usi.name }}
{{ END }}

{{ BUTTONS = BLOCK }}
    {{ FOR item IN ref(service.api_price_list).nsort('cost') }}
        [
            {
                "text": "{{ item.name }} - {{ item.cost }} —Ä—É–±/–º–µ—Å.",
                "callback_data": "user:keys:next:confirm {{ usi.user_service_id _ ' ' _ item.service_id }}"
            }
        ],
    {{ END }}
    [
        {
            "text": "‚≠ïÔ∏è –û—Ç–º–µ–Ω–∏—Ç—å",
            "callback_data": "user:keys:id {{ usi.user_service_id }}"
        }
    ]
{{ END }}
{{ send(TEXT=TEXT, BUTTONS=BUTTONS) }}


[%  #   QR Code —Å—Å—ã–ª–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏ %]
[% CASE ['user:keys:show'] %]
{{ subscription_url = storage.read('name', 'vpn_mrzb_' _ args.0).subscription_url }}
{{ TEXT = BLOCK }}
üåê <b>URL –ø–æ–¥–ø–∏—Å–∫–∏:</b>
<code>{{ subscription_url }}</code>
{{ END }}
{
    "printQrCode": {
        "data": "{{ subscription_url }}",
        "parameters": {
            "parse_mode": "HTML",
            "caption": "{{ TEXT.replace('\n', '\n') }}",
            "reply_markup": {
                "inline_keyboard": [
                    [
                        {
                            "text": "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é",
                            "callback_data": "start"
                        }
                    ]
                ]
            }
        }
    }
}


[%  # –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏
    # args.0 - id of user service
%]
[% CASE ['user:keys:delete', 'user:keys:delete:confirm'] %]
{{
  us = user.service.list_for_api('usi', args.0);
}}
{{ IF cmd == 'user:keys:delete:confirm' }}
{
    "shmServiceDelete": {
        "usi": "{{ args.0 }}",
        "callback_data": "{{ mainMenuCmd }}",
        "error": "–û–®–ò–ë–ö–ê"
    }
},
{
    "answerCallbackQuery": {
         "callback_query_id": {{ callback_query.id }},
         "parse_mode":"HTML",
         "text": "‚úÖ –ö–ª—é—á —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω!",
         "show_alert": true
     }
}
{{ ELSIF us.status != 'ACTIVE' && cmd != 'user:keys:delete:confirm' }}

{{ TEXT = BLOCK }}
ü§î <b>–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —É–¥–∞–ª–µ–Ω–∏–µ –∫–ª—é—á–∞ #{{ args.0 }}. –ö–ª—é—á –Ω–µ–ª—å–∑—è –±—É–¥–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å!</b>
{{ END }}

{{ BUTTONS = BLOCK }}
  [
    {
      "text": "üß® –î–ê, –£–î–ê–õ–ò–¢–¨! üî•",
      "callback_data": "user:keys:delete:confirm {{ args.0 }}"
    }
  ],
  [
      {
          "text": "‚á¶ –ù–∞–∑–∞–¥",
          "callback_data": "user:keys"
      }
  ]
{{ END }}
{{ send(TEXT=TEXT, BUTTONS=BUTTONS) }}

{{ END }}



[%  #   –ú–µ–Ω—é –ø–æ–∫—É–ø–∫–∏ / –ø—Ä–∞–π—Å-–ª–∏—Å—Ç %]
[% CASE ['price'] %]
{{ TEXT = BLOCK }}
‚ò∑ <b>–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ–Ω—ã–π –ø–ª–∞–Ω –∫–ª—é—á–∞ –¥–ª—è –∑–∞–∫–∞–∑–∞</b>
{{ END }}

{{ BUTTONS = BLOCK }}
    {{ FOR item IN ref(service.api_price_list).nsort('cost') }}
        [
            {
                "text": "{{ item.name }} - {{ item.cost }} —Ä—É–±/–º–µ—Å.",
                "callback_data": "order {{ item.service_id }}"
            }
        ],
    {{ END }}
        [
            {
                "text": "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é",
                "callback_data": "{{ mainMenuCmd }}"
            }
        ]
{{ END }}

{{ IF checkNotPaidServices == 1 }}
    {{ notPaid = user.services.list_for_api('filter', { 'status' => 'NOT PAID' }, 'limit', 1) }}
    {{ IF ref(notPaid).size == 1 }}
        {
            "answerCallbackQuery": {
                "callback_query_id": {{ callback_query.id }},
                "parse_mode":"HTML",
                "text": "‚õîÔ∏è –£ –≤–∞—Å –∏–º–µ–µ—Ç—Å—è –Ω–µ–æ–ø–ª–∞—á–µ–Ω–Ω—ã–π –∫–ª—é—á!\nüîë #{{ notPaid.user_service_id }} - {{ notPaid.name }}\n –û–ø–ª–∞—Ç–∏—Ç–µ, –ª–∏–±–æ —É–¥–∞–ª–∏—Ç–µ –µ–≥–æ –¥–ª—è –ø–æ–∫—É–ø–∫–∏ –Ω–æ–≤–æ–≥–æ.",
                "show_alert": true
            }
        },
        {
            "shmRedirectCallback": {
                "callback_data": "user:keys"
            }
        }
        {{ STOP }}
    {{ END }}
{{ END }}
{{ send(TEXT=TEXT, BUTTONS=BUTTONS) }}

[%  #   –ö–µ–π—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —É—Å–ª—É–≥–∏
    #   args.0 - id —É—Å–ª—É–≥–∏
%]
[% CASE ['order'] %]
{
    "shmServiceOrder": {
        "service_id": {{ args.0 }},
        "callback_data": "/start",
        "cb_not_enough_money": "user:cabinet",
        "error": "<b>ERROR for service order</b>"
    }
},
{
    "answerCallbackQuery": {
         "callback_query_id": {{ callback_query.id }},
         "parse_mode":"HTML",
         "text": "‚úÖ –ö–ª—é—á –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω.",
         "show_alert": true
     }
}


[%  #   –ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π  %]
[% CASE ['user:pays'] %]
{{
    # Variables
    limit = 5;
    offset = args.0 || 0;
    pays = ref(user.pays.list_for_api('limit', limit, 'offset', offset ));
}}
{{ TEXT = BLOCK }}
‚ò∞ <b>–ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π</b>
{{ END }}

{{ BUTTONS = BLOCK }}
    {{ FOR item in pays }}
        [
            {
                "text": "–î–∞—Ç–∞: {{ item.date }}, –°—É–º–º–∞: {{ item.money }} —Ä—É–±.",
                "callback_data": "user:cabinet"
            }
        ],
    {{ END }}
    {{ IF pays.size == limit || offset > 0 }}
        [
        {{ IF offset > 0 }}
            {
                "text": "‚¨ÖÔ∏è –ù–∞–∑–∞–¥",
                "callback_data": "user:pays {{ offset - limit }}"
            },
        {{ END }}
        {{ IF pays.size == limit }}
            {
                "text": "–ï—â—ë ‚û°Ô∏è",
                "callback_data": "user:pays {{ limit + offset }}"
            }
        {{ END }}
        ],
    {{ END }}
    [
        {
            "text": "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é",
            "callback_data": "{{ mainMenuCmd }}"
        }
    ]
{{ END }}
{{ send(TEXT=TEXT, BUTTONS=BUTTONS) }}


[%  # –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ %]
[% CASE ['user:referrals'] %]
{{ TEXT = BLOCK }}
ü§ù <b>–ü–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞</b>

–ü—Ä–∏–≥–ª–∞—à–∞–π –¥—Ä—É–∑–µ–π –∏ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π {{ config.billing.partner.income_percent }}% —Å –∏—Ö –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–π. –ó–∞—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ –¥–µ–Ω—å–≥–∏ –º–æ–∂–Ω–æ –ø–æ—Ç—Ä–∞—Ç–∏—Ç—å –Ω–∞ –ø–æ–∫—É–ø–∫—É –∏–ª–∏ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ –∫–ª—é—á–∞.
‚¨áÔ∏èÔ∏è –¢–≤–æ—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞:
‚îî <code>https://t.me/{{ botUsername }}?start={{ toBase64Url(toQueryString( partner_id = user.id )) }}</code>
üèÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:
‚îú –ü—Ä–∏–≤–µ–¥–µ–Ω–æ –¥—Ä—É–∑–µ–π: {{ user.referrals_count }}
‚îî –î–æ—Å—Ç—É–ø–Ω–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é: {{ user.get_bonus }} ‚ÇΩ
{{ END }}
{{ BUTTONS = BLOCK }}
    [
        {
            "text": "üë§ –ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–≥–∞",
            "url": "https://t.me/share/url?url=https://t.me/{{ botUsername }}?start={{ toBase64Url(toQueryString( partner_id = user.id )) }}"
        }
    ],
    [
        {
            "text": "üìÉ –°–ø–∏—Å–æ–∫ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–Ω—ã—Ö",
            "callback_data": "user:referrals:list"
        }
    ],
    [
        {
            "text": "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é",
            "callback_data": "{{ mainMenuCmd }}"
        }
    ]
{{ END }}
{{ send(TEXT=TEXT, BUTTONS=BUTTONS) }}


[%  # –°–ø–∏—Å–æ–∫ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–Ω—ã—Ö %]
[% CASE ['user:referrals:list'] %]
{{
    limit = 7;
    offset = (args.0 || 0);
    referralsArray = ref(user.list_for_api('admin', 1, 'limit', limit, 'offset', offset, 'filter',{"partner_id" = user.id}));
}}
{{ TEXT = BLOCK }}
üìÉ <b>–°–ø–∏—Å–æ–∫ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</b>

–í—Å–µ–≥–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–æ: {{ user.referrals_count }}
{{ END }}

{{ BUTTONS = BLOCK }}
    {{ FOR item in referralsArray }}
        [
            {
                "text": "{{ item.full_name }}",
                "callback_data": "user:referrals:list"
            }
        ],
    {{ END }}
    {{ IF referralsArray.size == limit || offset > 0}}
    [
        {{ IF offset > 0 }}
            {
                "text": "‚¨ÖÔ∏è –ù–∞–∑–∞–¥",
                "callback_data": "user:referrals:list {{ offset - limit }}"
            },
        {{ END }}
        {{ IF referralsArray.size == limit }}
            {
                "text": "–ï—â—ë ‚û°Ô∏è",
                "callback_data": "user:referrals:list {{ limit + offset }}"
            }
        {{ END }}
    ],
    {{ END }}
    [
        {
            "text": "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é",
            "callback_data": "{{ mainMenuCmd }}"
        }
    ]
{{ END }}
{{ send(TEXT=TEXT, BUTTONS=BUTTONS) }}


[%  #   –ü–æ–º–æ—â—å %]
[% CASE ['help'] %]
{{ TEXT = BLOCK }}
<b>–ü–æ –≤—Å–µ–º –≤–æ–ø—Ä–æ—Å–∞–º –≤—ã –º–æ–∂–µ—Ç–µ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –≤ —á–∞—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏</b>
{{ END }}

{{ BUTTONS = BLOCK }}
    [
        {
            "text": "üí¨ –ß–∞—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏",
            "url": "{{ supportUrl }}"
        }
    ],
    [
        {
            "text": "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é",
            "callback_data": "{{ mainMenuCmd }}"
        }
    ]
{{ END }}
{{ send(TEXT=TEXT, BUTTONS=BUTTONS) }}

[%# ########################################################################################### %]
[%# ############################### ADMIN PANEL ############################################### %]
[%# ########################################################################################### %]

[% CASE ['admin:menu'] %]
{{ TEXT = BLOCK }}
„Ä† <b>–ú–µ–Ω—é {{ role = (user.settings.role == 'admin' ? '–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞' : '–º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞'); role; }}</b>

‚≠ïÔ∏è –ë—É–¥—å—Ç–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã —Å –≤—ã–±–æ—Ä–æ–º –¥–µ–π—Å—Ç–≤–∏–π!
{{ END }}

{{ BUTTONS = BLOCK }}
    [
        {
            "text": "üë®‚Äçüíª –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏",
            "callback_data": "admin:users:list"
        }
    ],
    {{ IF user.settings.role == 'admin' || (user.settings.role == 'moderator' && user.settings.moderate.settings == 1 )}}
        [
            {
                "text": "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞",
                "callback_data": "admin:settings"
            }
        ],
    {{ END }}
    [
        {
            "text": "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é",
            "callback_data": "{{ mainMenuCmd }}"
        }
    ]
{{ END }}
{{ send(TEXT=TEXT, BUTTONS=BUTTONS, admin=1) }}

[% CASE ['admin:settings'] %]
{{ PROCESS checkAdminRights }}
{{ checkModeratorRights(right="settings") }}

{{ TEXT = BLOCK }}
<b>–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–æ—Ç–∞</b>

–ó–∞–ø—Ä–µ—Ç–∏—Ç—å –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –∫–ª—é—á–µ–π, –µ—Å–ª–∏ –µ—Å—Ç—å –Ω–µ–æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ: {{ notPaidStatus = (checkNotPaidServices == 0 ? '‚≠ïÔ∏è –í—ã–∫–ª—é—á–µ–Ω–æ' : 'üü¢ –í–∫–ª—é—á–µ–Ω–æ'); notPaidStatus; }}

–¢–∏–ø —Å–æ–æ–±—â–µ–Ω–∏–π: {{ messageTypeStatus = (defaultMessageType == 'editMessageText' ? '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ' : 'üÜï –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ'); messageTypeStatus; }}
{{ END }}

{{ BUTTONS = BLOCK }}
    [
        {
            "text": "–ò–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–µ—Ç –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è",
            "callback_data": "admin:settings:change notpaid"
        }
    ],
    [
        {
            "text": "–ò–∑–º–µ–Ω–∏—Ç—å —Ç–∏–ø —Å–æ–æ–±—â–µ–Ω–∏–π",
            "callback_data": "admin:settings:change msg"
        }
    ],
    [
        {
            "text": "üë®‚Äçüíª –ú–µ–Ω—é {{ menuRole = (user.settings.role == 'admin' ? '–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞' : '–º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞'); menuRole; }}",
            "callback_data": "admin:menu"
        },
        {
            "text": "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é",
            "callback_data": "{{ mainMenuCmd }}"
        }
    ]
{{ END }}
{{ send(TEXT=TEXT, BUTTONS=BUTTONS) }}


[%  #   –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π %]
[% CASE ['admin:settings:change'] %]
{{ PROCESS checkAdminRights }}

{{ IF args.0 == 'notpaid' }}
{{      
        IF checkNotPaidServices == 0;
            ret = user.id(1).storage.save('bot_configuration', 'checkNotPaidServices' => 1, 'messageType' => defaultMessageType, 'menuCmd' => mainMenuCmd );
        ELSIF checkNotPaidServices == 1;
            ret = user.id(1).storage.save('bot_configuration', 'checkNotPaidServices' => 0, 'messageType' => defaultMessageType, 'menuCmd' => mainMenuCmd );
        END;
}}
{
    "answerCallbackQuery": {
         "callback_query_id": {{ callback_query.id }},
         "parse_mode":"HTML",
         "text": "‚úÖ –ó–∞–ø—Ä–µ—Ç –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –∫–ª—é—á–µ–π –∏–∑–º–µ–Ω–µ–Ω!",
        "show_alert": true
     }
},
{
    "shmRedirectCallback": {
        "callback_data": "admin:settings"
    }
}
{{ ELSIF args.0 == 'msg' }}
{{
    IF defaultMessageType == 'sendMessage';
        ret = user.id(1).storage.save('bot_configuration', 'checkNotPaidServices' => checkNotPaidServices, 'messageType' => 'editMessageText', 'menuCmd' => 'menu' );
    ELSIF defaultMessageType == 'editMessageText';
        ret = user.id(1).storage.save('bot_configuration', 'checkNotPaidServices' => checkNotPaidServices, 'messageType' => 'sendMessage', 'menuCmd' => 'start' );
    END;
}}
{
    "answerCallbackQuery": {
         "callback_query_id": {{ callback_query.id }},
         "parse_mode":"HTML",
         "text": "‚úÖ –¢–∏–ø —Å–æ–æ–±—â–µ–Ω–∏–π –∏–∑–º–µ–Ω–µ–Ω!",
        "show_alert": true
     }
},
{
    "shmRedirectCallback": {
        "callback_data": "admin:settings"
    }
}
{{ END }}


[% CASE ['admin:users:list'] %]
{{
    limit = 7;
    offset = (args.0 || 0);
    users = ref(user.list_for_api('admin', 1, 'limit', limit, 'offset', offset, 'filter',{"gid" = 0}));
    getCountUsers = ref(user.list_for_api('admin', 1, filter, {"gid" = 0})).size;
}}
{{ TEXT = BLOCK }}
üë®‚Äçüíª –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏

üë§ –í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {{ getCountUsers - 1 }}
{{ END }}

{{ BUTTONS = BLOCK }}
    {{ FOR item in users }}
        {{ status = (item.block == 0 ? "üü¢" : "üî¥") }}
        [
            {
                "text": "{{ status _' '_ item.full_name.replace('"', '\"')  }} ({{ item.user_id _'-'_ item.login }})",
                "callback_data": "admin:users:id {{ item.user_id _' '_ offset }}"
            }
        ],
    {{ END }}
    {{ IF users.size == limit || offset > 0}}
        [
        {{ IF offset > 0 }}
            {
                "text": "‚¨ÖÔ∏è –ù–∞–∑–∞–¥",
                "callback_data": "admin:users:list {{ offset - limit }}"
            },
        {{ END }}
        {{ IF users.size == limit }}
            {
                "text": "–ï—â—ë ‚û°Ô∏è",
                "callback_data": "admin:users:list {{ limit + offset }}"
            }
        {{ END }}
        ],
    {{ END }}
    [
        {
            "text": "üë®‚Äçüíª –ú–µ–Ω—é {{ menuRole = (user.settings.role == 'admin' ? '–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞' : '–º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞'); menuRole; }}",
            "callback_data": "admin:menu"
        },
        {
            "text": "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é",
            "callback_data": "{{ mainMenuCmd }}"
        }
    ]
{{ END }}
{{ send(TEXT=TEXT, BUTTONS=BUTTONS, admin=1) }}

[% CASE ['admin:users:id'] %]
{{
    userData = user.id(args.0);
    userPartner = user.id(userData.partner_id);
    userServices = ref(userData.services.list_for_api('category','%'));
    offset = args.1;
}}

{{ TEXT = BLOCK }}
üë§ <b>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ</b>

–°—Ç–∞—Ç—É—Å: {{ userStatus = (userData.block == 0 ? "üü¢ –ê–∫—Ç–∏–≤–µ–Ω" : "üî¥ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω"); userStatus; }}

–ò–º—è: {{ userData.full_name.replace('"', '\"')  }}
ID: {{ userData.user_id }}
Telegram: {{ userData.settings.telegram.login }}
–õ–æ–≥–∏–Ω: {{ userData.login }}

–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: {{ userData.created }}
–î–∞—Ç–∞ –ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è: {{ userData.last_login }}
–ö—Ç–æ –ø—Ä–∏–≥–ª–∞—Å–∏–ª: {{ userPartner.full_name _' - '_ userPartner.login }}

–ë–∞–ª–∞–Ω—Å: {{ userData.balance }} —Ä—É–±.
–ë–æ–Ω—É—Å—ã: {{ userData.get_bonus }} —Ä—É–±.
–°–∫–∏–¥–∫–∞: {{ userData.discount }}

–ö–æ–ª-–≤–æ –ø–æ–¥–ø–∏—Å–æ–∫: {{ userServices.size }}

{{ END }}

{{ BUTTONS = BLOCK }}
    [
        {
            "text": "üîê –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∞–º–∏",
            "callback_data": "admin:users:id:subs {{ userData.user_id _' '_ offset }}"
        }
    ],
    [
        {
            "text": "üí∏ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞–º–∏",
            "callback_data": "admin:users:id:pays {{ userData.user_id }}"
        }
    ],
    [
        {
            "text": "üéÅ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–æ–Ω—É—Å–∞–º–∏",
            "callback_data": "admin:users:id:bonuses {{ userData.user_id }}"
        }
    ],
    [
        {
            "text": "{{ status = (userData.block == 0 ? "üî¥ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å" : "üü¢ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å"); status; }}",
            "callback_data": "admin:users:block {{ userData.user_id }}"
        }
    ],
    [
        {
            "text": "‚¨ÖÔ∏è –ù–∞–∑–∞–¥",
            "callback_data": "admin:users:list {{ args.1 }}"
        }
    ],
    [
        {
            "text": "üë®‚Äçüíª –ú–µ–Ω—é {{ menuRole = (user.settings.role == 'admin' ? '–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞' : '–º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞'); menuRole; }}",
            "callback_data": "admin:menu"
        },
        {
            "text": "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é",
            "callback_data": "{{ mainMenuCmd }}"
        }
    ]
{{ END }}
{{ send(TEXT=TEXT, BUTTONS=BUTTONS, admin=1) }}


[% CASE ['admin:users:block'] %]
{{ PROCESS checkAdminRights }}
{{ checkModeratorRights(right="blockUser") }}

{{
    # Arguments 
    #   0. - id of user

    # Variables
        userData = user.id(args.0);
}}
{{ retcode = (userData.block == 1 ? "0" : "1"); }}
{{ ret = userData.set(block = retcode) }}
{
    "answerCallbackQuery": {
         "callback_query_id": {{ callback_query.id }},
         "parse_mode":"HTML",
         "text": "‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {{ userData.full_name.replace('"', '\"')  }} ({{ userData.user_id }}) {{ status = (userData.block == 1 ? "üî¥ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω" : "üü¢ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω"); status; }}",
         "show_alert": true
     }
},
{
    "shmRedirectCallback": {
        "callback_data": "admin:users:id {{ userData.user_id }}"
    }
}


[% CASE ['admin:users:id:subs'] %]
{{ checkModeratorRights(right="listSubs") }}
{{
    limit = 7;
    last_offset = (args.1 || 0);
    offset = (args.2 || 0);
    userData = user.id(args.0);
    userServices = ref(userData.services.list_for_api('limit', limit, 'offset', offset));
}}
{{ TEXT = BLOCK }}
üîê –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∞–º–∏

–ò–º—è: {{ userData.full_name.replace('"', '\"')  }}
ID: {{ userData.user_id }}
Telegram: {{ userData.settings.telegram.login }}
–õ–æ–≥–∏–Ω: {{ userData.login }}

{{ IF userServices.size <= 0}}
<b>–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –ø–æ–¥–ø–∏—Å–æ–∫!</b>
{{ END }}
{{ END }}

{{ BUTTONS = BLOCK }}
    {{ FOR item in userServices }}
    {{ status = (item.status == 'ACTIVE' ? "üü¢" : "üî¥") }}
        [
            {
                "text": "{{ status; item.user_service_id _' - '_ item.name  }}",
                "callback_data": "admin:subs:id {{ item.user_service_id _ ' ' _ item.user_id }}"
            }
        ],
    {{ END }}
    {{ IF userServices.size == limit }}
        [
            {
                "text": "–ï—â—ë ‚û°Ô∏è",
                "callback_data": "admin:users:list {{ limit + offset }}"
            }
        ],
    {{ END }}
    {{ IF offset > 0 }}
        [
            {
                "text": "‚¨ÖÔ∏è –ù–∞–∑–∞–¥",
                "callback_data": "admin:users:list {{ offset - limit }}"
            }
        ],
    {{ END }}
    [
        {
            "text": "‚ûï –î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥—É",
            "callback_data": "admin:subs:add {{ userData.user_id }}"
        }
    ],
    [
        {
            "text": "‚ûï –î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥—É (–±–µ—Å–ø–ª–∞—Ç–Ω–æ)",
            "callback_data": "admin:subs:add:free {{ userData.user_id }}"
        }
    ],
    [
        {
            "text": "‚¨ÖÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ",
            "callback_data": "admin:users:id {{ userData.user_id _' '_ last_offset }}"
        }
    ],
    [
        {
            "text": "üë®‚Äçüíª –ú–µ–Ω—é {{ menuRole = (user.settings.role == 'admin' ? '–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞' : '–º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞'); menuRole; }}",
            "callback_data": "admin:menu"
        }
    ]
{{ END }}
{{ send(TEXT=TEXT, BUTTONS=BUTTONS, admin=1) }}


[% CASE ['admin:subs:add'] %]
{{ checkModeratorRights(right="addSubs") }}
{{
    # Variables
    userData = user.id(args.0);
    servicesArray = ref(service.list_for_api).nsort('service_id');
}}
{{ TEXT = BLOCK }}
‚ûï –í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {{ userData.full_name.replace('"', '\"')  }} ({{ userData.user_id }})
{{ END }}

{{ BUTTONS = BLOCK }}
    {{ FOR item in servicesArray }}
        [
            {
                "text": "{{ item.name _' '_ item.descr }} - {{ item.cost }} ‚ÇΩ",
                "callback_data": "admin:subs:add:confirm {{ userData.user_id _' '_ item.service_id }}"
            }
        ],
    {{ END }}
    [
        {
            "text": "‚¨ÖÔ∏è –ù–∞–∑–∞–¥",
            "callback_data": "admin:users:id:subs {{ userData.user_id _' '_ args.1 }}"
        }
    ],
    [
        {
            "text": "‚¨ÖÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ",
            "callback_data": "admin:users:id {{ userData.user_id _' '_ last_offset }}"
        }
    ]
{{ END }}
{{ send(TEXT=TEXT, BUTTONS=BUTTONS, admin=1) }}


[% CASE ['admin:subs:add:free'] %]
{{ checkModeratorRights(right="addFreeSubs") }}
{{
    # Variables
    userData = user.id(args.0);
    servicesArray = ref(service.list_for_api).nsort('service_id');
}}
{{ TEXT = BLOCK }}
‚ûï –í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É —Å 0 —Å—Ç–æ–∏–º–æ—Å—Ç—å—é –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {{ userData.full_name.replace('"', '\"')  }} ({{ userData.user_id }})
{{ END }}

{{ BUTTONS = BLOCK }}
    {{ FOR item in servicesArray }}
        [
            {
                "text": "{{ item.name _' '_ item.descr }} - {{ item.cost }} ‚ÇΩ",
                "callback_data": "admin:subs:add:confirm {{ userData.user_id _' '_ item.service_id _' free' }}"
            }
        ],
    {{ END }}
    [
        {
            "text": "‚¨ÖÔ∏è –ù–∞–∑–∞–¥",
            "callback_data": "admin:users:id:subs {{ userData.user_id _' '_ args.1 }}"
        }
    ],
    [
        {
            "text": "‚¨ÖÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ",
            "callback_data": "admin:users:id {{ userData.user_id _' '_ last_offset }}"
        }
    ]
{{ END }}
{{ send(TEXT=TEXT, BUTTONS=BUTTONS, admin=1) }}


[% CASE ['admin:subs:add:confirm'] %]
{{ PROCESS checkAdminRights }}
{{
    userData = user.id(args.0);
    createService = service.id(args.1);
    user = user.switch(userData.user_id);
}}
{{ IF args.2 == 'free'}}
{{ ret = userData.us.create('service_id' = createService.service_id, 'cost' = 0, 'check_allow_to_order' = 0) }}
{{ ELSE }}
{{ ret = userData.us.create('service_id' = createService.service_id, 'check_allow_to_order' = 0) }}
{{ END }}
{{ TEXT = BLOCK }}
‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ {{ createService.name }} —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {{ userData.full_name.replace('"', '\"')  }} ({{ userData.user_id }})
{{ END }}
{
    "answerCallbackQuery": {
         "callback_query_id": {{ callback_query.id }},
         "parse_mode":"HTML",
         "text": "{{ TEXT.replace('\n','\n') }}",
         "show_alert": true
     }
},
{
    "shmRedirectCallback": {
        "callback_data": "admin:users:id:subs {{ userData.user_id }}"
    }
}


[% CASE ['admin:subs:id'] %]
{{ checkModeratorRights(right="listSubs") }}
{{
    # Arguments:
        # 0 - ID of user service id 
        # 1 - ID of user
    # Variables:
    USE date;
    userData = user.id(args.1);
    userService = userData.us.id(args.0);
    userServiceData = service.id(userService.service_id);
    userServiceNext = service.id(userService.next);
    userSubUrl = (userData.storage.read('name', 'vpn_mrzb_'_ userService.user_service_id).subscription_url || "https://notfound.com");
    subData = http.get(userSubUrl _'/info');
}}
{{ TEXT = BLOCK }}
üîê –ü–æ–¥–ø–∏—Å–∫–∞ {{ userServiceData.name }} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {{ userData.full_name.replace('"', '\"') }} ({{ userData.user_id }})

ID: {{ userService.user_service_id }}
ID —Å–ø–∏—Å–∞–Ω–∏—è: {{ userService.withdraw_id }}
–°—Ç–∞—Ç—É—Å: {{ userService.status }}
–°–æ–∑–¥–∞–Ω–∞: {{ userService.created }}
–ó–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è: {{ userService.expire }}
–°–ª–µ–¥—É—é—â–∏–π —Ç–∞—Ä–∏—Ñ: {{ userServiceNext.name }}

–ü–æ—Å–ª–µ–¥–Ω–∏–π –æ–Ω–ª–∞–π–Ω: {{ subData.online_at ? date.format(subData.online_at, '%d.%m.%Y %R') : '–Ω–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏' }}

{{ END }}

{{ BUTTONS = BLOCK }}
    [
        {
            "text": "üîó –ü–æ–¥–ø–∏—Å–∫–∞ {{ userService.user_service_id }} - {{ userServiceData.name }}",
            "web_app": {
                "url": "{{ userSubUrl }}"
            }
        }
    ],
    {{ IF userService.status == 'ACTIVE' || userService.status == 'BLOCK' }}
        [
            {
                "text": "{{ status = (userService.status == 'ACTIVE' ? "üî¥ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å" : "üü¢ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å"); status; }}",
                "callback_data": "admin:subs:change:status {{ userService.user_service_id }}"
            }
        ],
    {{ ELSIF userService.status == 'PROGRESS' }}
        [
            {
                "text": "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ (–æ–±–Ω–æ–≤–∏—Ç–µ)",
                "callback_data": "admin:subs:id {{ userService.user_service_id }}"
            }
        ],
    {{ END }}
    {{ IF userService.status == 'BLOCK' || userService.status == 'NOT PAID' }}
        [
            {
                "text": "‚ùå –£–¥–∞–ª–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É",
                "callback_data": "admin:subs:delete {{ userService.user_service_id }}"
            }
        ],
    {{ END }}
    [
        {
            "text": "ü´∞ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–ø–∏—Å–∞–Ω–∏–∏",
            "callback_data": "admin:withdraws:id {{ userService.withdraw_id }}"
        }
    ],
    [
        {
            "text": "‚éò –°–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â. —Ç–∞—Ä–∏—Ñ",
            "callback_data": "admin:subs:change:current {{ userService.user_service_id }}"
        }
    ],
    [
        {
            "text": "‚éò –°–º–µ–Ω–∏—Ç—å —Å–ª–µ–¥. —Ç–∞—Ä–∏—Ñ",
            "callback_data": "admin:subs:change:next {{ userService.user_service_id }}"
        }
    ],
    [
        {
            "text": "‚¨ÖÔ∏è –ù–∞–∑–∞–¥",
            "callback_data": "admin:users:id:subs {{ userData.user_id }}"
        }
    ],
    [
        {
            "text": "üë®‚Äçüíª –ú–µ–Ω—é {{ menuRole = (user.settings.role == 'admin' ? '–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞' : '–º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞'); menuRole; }}",
            "callback_data": "admin:menu"
        },
        {
            "text": "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é",
            "callback_data": "{{ mainMenuCmd }}"
        }
    ]
{{ END }}
{{ send(TEXT=TEXT, BUTTONS=BUTTONS, admin=1) }}


[% ####### CHANGE CURRENT PLAN FOR SUBSCRIPTION ###### %]

[% CASE ['admin:subs:change:current'] %]
{{ checkModeratorRights(right="changeSubs") }}
{{
    userService = ref(us.list_for_api('admin', 1, 'filter', {"user_service_id" = args.0})).first;
    userData = user.id(userService.user_id);
    userServiceData = service.id(userService.service_id);
}}
{{ TEXT = BLOCK }}
‚éò –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏ {{ userServiceData.name }} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {{ userData.full_name.replace('"', '\"')  }} ({{ userData.user_id }})

{{ END }}

{{ BUTTONS = BLOCK }}
    {{ FOR list IN ref(service.api_price_list).nsort('service_id') }}
        [
            {
                "text": "{{ list.name _' '_ list.descr }} - {{ list.cost }} ‚ÇΩ",
                "callback_data": "admin:subs:change:current:confirm {{ userService.user_service_id _ ' ' _ list.service_id }}"
            }
        ],
    {{ END }}
    [
        {
            "text": "‚¨ÖÔ∏è –ù–∞–∑–∞–¥",
            "callback_data": "admin:subs:id {{ userService.user_service_id }}"
        }
    ],
    [
        {
            "text": "üë®‚Äçüíª –ú–µ–Ω—é {{ menuRole = (user.settings.role == 'admin' ? '–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞' : '–º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞'); menuRole; }}",
            "callback_data": "admin:menu"
        },
        {
            "text": "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é",
            "callback_data": "{{ mainMenuCmd }}"
        }
    ]
{{ END }}
{{ send(TEXT=TEXT, BUTTONS=BUTTONS, admin=1) }}

[% CASE ['admin:subs:change:current:confirm'] %]
{{ PROCESS checkAdminRights }}
{{
    nextService = args.1;
    data = ref(us.list_for_api('admin', 1, 'filter', {"user_service_id" = args.0})).first;
    userData = user.id(data.user_id);
    serviceData = service.id(data.service_id);
    userServiceNext = service.id(nextService);
}}
{{ TEXT = BLOCK }}
‚úÖ –¢–∞—Ä–∏—Ñ –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏ {{ serviceData.name }} ({{ data.user_service_id }}) –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {{ userData.full_name.replace('"', '\"')  }} ({{ userData.user_id }}) –∏–∑–º–µ–Ω—ë–Ω –Ω–∞ {{ userServiceNext.name }}
{{ END }}
{
    "answerCallbackQuery": {
         "callback_query_id": {{ callback_query.id }},
         "parse_mode":"HTML",
         "text": "{{ TEXT.replace('\n','\n') }}",
         "show_alert": true
     }
},
{
    "shmRedirectCallback": {
        "callback_data": "admin:subs:id {{ data.user_service_id }}"
    }
}
{{ ret = userData.us.id(data.user_service_id).change('service_id' = nextService) }}


[% ####### Change next plan for subscription ##### %]
[% CASE ['admin:subs:change:next'] %]
{{ checkModeratorRights(right="changeSubs") }}
{{
    userService = ref(us.list_for_api('admin', 1, 'filter', {"user_service_id" = args.0})).first;
    userData = user.id(userService.user_id);
    userServiceData = service.id(userService.service_id);
    userServiceNext = service.id(userService.next);
}}
{{ TEXT = BLOCK }}
‚éò –í—ã–±–µ—Ä–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–π —Ç–∞—Ä–∏—Ñ –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏ {{ userServiceData.name }} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {{ userData.full_name.replace('"', '\"')  }} ({{ userData.user_id }})

{{ IF userService.next != userService.service_id || userService.next != 0 }}
–°–ª–µ–¥—É—é—â–∏–π —Ç–∞—Ä–∏—Ñ: {{ userServiceNext.name }} ({{ userService.next }})
{{ END }}
{{ END }}

{{ BUTTONS = BLOCK }}
    {{ FOR list IN ref(service.api_price_list).nsort('service_id') }}
        [
            {
                "text": "{{ list.name _' '_ list.descr }} - {{ list.cost }} ‚ÇΩ",
                "callback_data": "admin:subs:change:next:confirm {{ userService.user_service_id _ ' ' _ list.service_id }}"
            }
        ],
    {{ END }}
    [
        {
            "text": "‚¨ÖÔ∏è –ù–∞–∑–∞–¥",
            "callback_data": "admin:subs:id {{ userService.user_service_id }}"
        }
    ],
    [
        {
            "text": "üë®‚Äçüíª –ú–µ–Ω—é {{ menuRole = (user.settings.role == 'admin' ? '–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞' : '–º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞'); menuRole; }}",
            "callback_data": "admin:menu"
        },
        {
            "text": "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é",
            "callback_data": "{{ mainMenuCmd }}"
        }
    ]
{{ END }}
{{ send(TEXT=TEXT, BUTTONS=BUTTONS, admin=1) }}

[% CASE ['admin:subs:change:next:confirm'] %]
{{ PROCESS checkAdminRights }}
{{
    nextService = args.1;
    data = ref(us.list_for_api('admin', 1, 'filter', {"user_service_id" = args.0})).first;
    userData = user.id(data.user_id);
    serviceData = service.id(data.service_id);
    userServiceNext = service.id(nextService);
}}
{{ ret = userData.us.id(data.user_service_id).set("next", nextService) }}
{{ TEXT = BLOCK }}
‚úÖ –°–ª–µ–¥—É—é—â–∏–π —Ç–∞—Ä–∏—Ñ –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏ {{ serviceData.name }} ({{ data.user_service_id }}) –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {{ userData.full_name.replace('"', '\"') }} ({{ userData.user_id }}) –∏–∑–º–µ–Ω—ë–Ω –Ω–∞ {{ userServiceNext.name }}
{{ END }}
{
    "answerCallbackQuery": {
         "callback_query_id": {{ callback_query.id }},
         "parse_mode":"HTML",
         "text": "{{ TEXT.replace('\n','\n') }}",
         "show_alert": true
     }
},
{
    "shmRedirectCallback": {
        "callback_data": "admin:subs:id {{ data.user_service_id }}"
    }
}


[% CASE ['admin:subs:change:status'] %]
{{ PROCESS checkAdminRights }}
{{ checkModeratorRights(right="changeSubs") }}
{{
    data = ref(us.list_for_api('admin', 1, 'filter', {"user_service_id" = args.0})).first;
    userData = user.id(data.user_id);
    serviceData = service.id(data.service_id);
}}
{{ IF data.status == 'ACTIVE' }}
    {{ ret = userData.us.id(data.user_service_id).block }}
{{ ELSIF data.status == 'BLOCK' }}
    {{ ret = userData.us.id(data.user_service_id).activate }}
{{ END }}
{
    "answerCallbackQuery": {
         "callback_query_id": {{ callback_query.id }},
         "parse_mode":"HTML",
         "text": "‚úÖ –£—Å–ª—É–≥–∞ {{ serviceData.name }} ({{ data.user_service_id }}) –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {{ userData.full_name.replace('"', '\"')  }} ({{ userData.user_id }}) {{ status = (data.status == 'ACTIVE' ? "üî¥ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞" : "üü¢ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞"); status; }}",
        "show_alert": true
     }
},
{
    "shmRedirectCallback": {
        "callback_data": "admin:subs:id {{ data.user_service_id }}"
    }
}


[% CASE ['admin:subs:delete'] %]
{{ PROCESS checkAdminRights }}
{{ checkModeratorRights(right="deleteSubs") }}
{{
    data = ref(us.list_for_api('admin', 1, 'filter', {"user_service_id" = args.0})).first;
    userData = user.id(data.user_id);
    serviceData = service.id(data.service_id);
}}
{{ IF data.status == 'BLOCK' || data.status == 'NOT PAID' }}
    {{ ret = userData.us.id(data.user_service_id).delete }}
{{ END }}
{
    "answerCallbackQuery": {
         "callback_query_id": {{ callback_query.id }},
         "parse_mode":"HTML",
         "text": "‚ùå –£—Å–ª—É–≥–∞ {{ serviceData.name }} ({{ data.user_service_id }}) –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {{ userData.full_name.replace('"', '\"')  }} ({{ userData.user_id }}) —É–¥–∞–ª–µ–Ω–∞!",
        "show_alert": true
     }
},
{
    "shmRedirectCallback": {
        "callback_data": "admin:users:id:subs {{ userData.user_id }}"
    }
}


[% CASE ['admin:users:id:pays'] %]
{{ checkModeratorRights(right="listPays") }}
{{
    limit = 5;
    offset = args.1 || 0;
    userData = user.id(args.0);
    userPays = ref(userData.pays.list_for_api('limit', limit, 'offset', offset ));
}}
{{ TEXT = BLOCK }}
üë®‚Äçüíª –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {{ userData.full_name.replace('"', '\"')  }} ({{ userData.user_id }})

{{ END }}

{{ BUTTONS = BLOCK }}
    {{ FOR item in userPays }}
        [
            {
                "text": "(ID: {{ item.id }}), {{ item.money }} —Ä—É–±, {{ item.date }}",
                "callback_data": "admin:pays:id {{ item.id }}"
            }
        ],
    {{ END }}
    {{ IF offset > 0 }}
        [
            {
                "text": "‚¨ÖÔ∏è –ù–∞–∑–∞–¥",
                "callback_data": "admin:users:id:pays {{ userData.user_id _' ' }} {{ offset - limit }}"
            }
        ],
    {{ END }}
    {{ IF userPays.size == limit }}
        [
            {
                "text": "–ï—â—ë ‚û°Ô∏è",
                "callback_data": "admin:users:id:pays {{ userData.user_id _' ' }} {{ limit + offset }}"
            }
        ],
    {{ END }}
    [
        {
            "text": "‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–ª–∞—Ç–µ–∂",
            "callback_data": "admin:pays:add {{ userData.user_id }}"
        }
    ],
    [
        {
            "text": "‚¨ÖÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ",
            "callback_data": "admin:users:id {{ userData.user_id }}"
        }
    ],
    [
        {
            "text": "üë®‚Äçüíªüë®‚Äçüíª –ú–µ–Ω—é {{ menuRole = (user.settings.role == 'admin' ? '–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞' : '–º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞'); menuRole; }}",
            "callback_data": "admin:menu"
        },
        {
            "text": "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é",
            "callback_data": "{{ mainMenuCmd }}"
        }
    ]
{{ END }}
{{ send(TEXT=TEXT, BUTTONS=BUTTONS, admin=1) }}


[% CASE ['admin:pays:id'] %]
{{ checkModeratorRights(right="listPays") }}
{{
    userPay = ref(pay.list_for_api('admin', 1, 'filter', {"id" = args.0})).first;
    payData = userPay.comment.object;
    payMethod = payData.payment_method;
    payCard = payMethod.card;
    userData = user.id(userPay.user_id);
}}
{{ TEXT = BLOCK }}
üí∏ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–ª–∞—Ç–µ–∂–µ ID {{ userPay.id }} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {{ userData.full_name.replace('"', '\"')  }} ({{ userData.user_id }})

–î–∞—Ç–∞ –ø–ª–∞—Ç–µ–∂–∞: {{ userPay.date }}
–ü–ª–∞—Ç–µ–∂–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞: {{ userPay.pay_system_id }}
–°—É–º–º–∞: {{ userPay.money }} —Ä—É–±.

{{ IF userPay.comment.comment }}
<b>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –ø–ª–∞—Ç–µ–∂—É</b>
<blockquote>{{ userPay.comment.comment }}</blockquote>
{{ END }}

{{ IF payData }}
<b>–î–∞–Ω–Ω—ã–µ –æ –ø–ª–∞—Ç–µ–∂–µ</b>
<blockquote>
ID –≤ —Å–∏—Å—Ç–µ–º–µ: {{ payData.id }}
–°—Ç–∞—Ç—É—Å: {{ payData.status }}
{{ IF payCard }}
–¢–∏–ø –∫–∞—Ä—Ç—ã: {{ payCard.card_type }}
–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã: {{ payCard.first6 }}******{{ payCard.last4 }}
–ë–∞–Ω–∫: {{ payCard.issuer_name }}
–°—Ç—Ä–∞–Ω–∞ –±–∞–Ω–∫–∞: {{ payCard.issuer_country }}
–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è: {{ payCard.expiry_month }}/{{ payCard.expiry_year }}
{{ END }}
{{ IF payMethod.type == 'sbp' }}
–¢–∏–ø –æ–ø–ª–∞—Ç—ã: –°–ë–ü
–ù–æ–º–µ—Ä –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ –°–ë–ü: {{ payMethod.sbp_operation_id }}
–ë–∏–∫ –ë–∞–Ω–∫–∞: {{ payMethod.payer_bank_details.bic }}
{{ END }}

{{ IF payMethod.title.match('YooMoney') }}
–ö–æ—à–µ–ª–µ–∫ YooMoney: {{ payMethod.title }}
ID –∫–æ—à–µ–ª—å–∫–∞: {{ payMethod.account_number }}
{{ END }}
</blockquote>
{{ END }}

{{ END }}

{{ BUTTONS = BLOCK }}
    [
        {
            "text": "‚¨ÖÔ∏è –ù–∞–∑–∞–¥",
            "callback_data": "admin:users:id:pays {{ userPay.user_id }}"
        }
    ],
    [
        {
            "text": "üë®‚Äçüíª –ú–µ–Ω—é {{ menuRole = (user.settings.role == 'admin' ? '–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞' : '–º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞'); menuRole; }}",
            "callback_data": "admin:menu"
        },
        {
            "text": "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é",
            "callback_data": "{{ mainMenuCmd }}"
        }
    ]
{{ END }}
{{ send(TEXT=TEXT, BUTTONS=BUTTONS, admin=1) }}


[% CASE ['admin:pays:add'] %]
{{ checkModeratorRights(right="addPays") }}
{{
    userData = user.id(args.0);
}}
{{ TEXT = BLOCK }}
üí∏ –í—ã–±–µ—Ä–∏—Ç–µ —Å—É–º–º—É, –∫–æ—Ç–æ—Ä—É—é —Ö–æ—Ç–∏—Ç–µ –Ω–∞—á–∏—Å–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {{ userData.full_name.replace('"', '\"')  }} ({{ userData.user_id }})
–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å {{ userData.balance }} —Ä—É–±.

{{ END }}
{{ BUTTONS = BLOCK }}
    [
        {
            "text": "10 —Ä—É–±",
            "callback_data": "admin:pays:add:confirm {{ userData.user_id }} 10"
        },
        {
            "text": "20 —Ä—É–±",
            "callback_data": "admin:pays:add:confirm {{ userData.user_id }} 20"
        }
    ],
    [
        {
            "text": "50 —Ä—É–±",
            "callback_data": "admin:pays:add:confirm {{ userData.user_id }} 50"
        },
        {
            "text": "100 —Ä—É–±",
            "callback_data": "admin:pays:add:confirm {{ userData.user_id }} 100"
        }
    ],
    [
        {{ FOR item IN ref(service.api_price_list('category', '%')).nsort('cost') }}
                
            {
                "text": "{{ item.cost }} —Ä—É–±",
                "callback_data": "admin:pays:add:confirm {{ userData.user_id _ ' ' }} {{ item.cost }}"
            },
        {{ END }}
    ],
    [
        {
            "text": "–í–≤–µ—Å—Ç–∏ —Å–≤–æ—é —Å—É–º–º—É",
            "callback_data": "admin:pays:add:manual {{ userData.user_id }}"
        }
    ],
    [
        {
            "text": "‚¨ÖÔ∏è –ù–∞–∑–∞–¥",
            "callback_data": "admin:users:id:pays {{ userData.user_id }}"
        }
    ],
    [
        {
            "text": "üë®‚Äçüíª –ú–µ–Ω—é {{ menuRole = (user.settings.role == 'admin' ? '–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞' : '–º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞'); menuRole; }}",
            "callback_data": "admin:menu"
        },
        {
            "text": "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é",
            "callback_data": "{{ mainMenuCmd }}"
        }
    ]
{{ END }}
{{ send(TEXT=TEXT, BUTTONS=BUTTONS, admin=1) }}


[%#
    –†—É—á–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
%]
[% CASE ['admin:pays:add:manual'] %]
{{ checkModeratorRights(right="addPays") }}
{{
    userData = user.id(args.0);

    ret = user.set_settings({'state' => 'awaiting_amount'});
    ret = user.set_settings({'bot' => {'switchUser' => userData.user_id} });
}}

{{ TEXT = BLOCK }}
üí¨ –í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {{ userData.full_name.replace('"', '\"') }}
{{ END }}
{{ notification(TEXT=TEXT, force=1) }}


[% CASE ['admin:pays:add:confirm'] %]
{{ PROCESS checkAdminRights }}
{{ checkModeratorRights(right="addPays") }}
{{
    userData = user.id(args.0);
    amount = args.1;
    pay = userData.payment('money', amount, 'pay_system_id', 'manual')
}}
{
    "answerCallbackQuery": {
         "callback_query_id": {{ callback_query.id }},
         "parse_mode":"HTML",
         "text": "–ë–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {{ userData.full_name.replace('"', '\"')  }} ({{ userData.user_id }}) –ø–æ–ø–æ–ª–Ω–µ–Ω –Ω–∞ {{ amount }} —Ä—É–±. –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å - {{ userData.balance }}",
         "show_alert": true
     }
},
{
    "shmRedirectCallback": {
        "callback_data": "admin:pays:add {{ userData.user_id }}"
    }
}



[% CASE ['admin:users:id:bonuses'] %]
{{ checkModeratorRights(right="listBonus") }}
{{
    limit = 5;
    offset = (args.1 || 0);
    userData = user.id(args.0);
    userBonuses = ref(bonus.list_for_api('admin', 1, 'limit', limit, 'offset', offset, 'filter', {"user_id" = userData.user_id}));
}}
{{ TEXT = BLOCK }}
üë®‚Äçüíª –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–æ–Ω—É—Å–∞–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {{ userData.full_name.replace('"', '\"')  }} ({{ userData.user_id }})

–ë–∞–ª–∞–Ω—Å –±–æ–Ω—É—Å–æ–≤: {{ userData.get_bonus }} —Ä—É–±.
{{ END }}

{{ BUTTONS = BLOCK }}
    {{ FOR item in userBonuses }}
        [
            {
                "text": "(ID: {{ item.id }}), {{ item.bonus }} —Ä—É–±., {{ item.date }}",
                "callback_data": "admin:bonuses:id {{ item.id _ ' ' _ offset }}"
            }
        ],
    {{ END }}
    {{ IF offset > 0 }}
        [
            {
                "text": "‚¨ÖÔ∏è –ù–∞–∑–∞–¥",
                "callback_data": "admin:users:id:bonuses {{ userData.user_id _' ' }} {{ offset - limit }}"
            }
        ],
    {{ END }}
    {{ IF userBonuses.size == limit }}
        [
            {
                "text": "–ï—â—ë ‚û°Ô∏è",
                "callback_data": "admin:users:id:bonuses {{ userData.user_id _' ' }} {{ limit + offset }}"
            }
        ],
    {{ END }}
    [
        {
            "text": "‚ûï –î–æ–±–∞–≤–∏—Ç—å –±–æ–Ω—É—Å—ã",
            "callback_data": "admin:bonuses:add {{ userData.user_id }}"
        }
    ],
    [
        {
            "text": "‚¨ÖÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ",
            "callback_data": "admin:users:id {{ userData.user_id }}"
        }
    ],
    [
        {
            "text": "üë®‚Äçüíª –ú–µ–Ω—é {{ menuRole = (user.settings.role == 'admin' ? '–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞' : '–º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞'); menuRole; }}",
            "callback_data": "admin:menu"
        },
        {
            "text": "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é",
            "callback_data": "{{ mainMenuCmd }}"
        }
    ]
{{ END }}
{{ send(TEXT=TEXT, BUTTONS=BUTTONS, admin=1) }}


[% CASE ['admin:bonuses:id'] %]
{{ checkModeratorRights(right="listBonus") }}
{{
    offset = args.1;
    data = ref(bonus.list_for_api('admin', 1, 'limit', limit, 'offset', offset, 'filter', {"id" = args.0})).first;
    userData = user.id(data.user_id);
    partnerData = user.id(data.comment.from_user_id)
}}
{{ TEXT = BLOCK }}
üí∏ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–∏ –±–æ–Ω—É—Å–æ–≤ ID {{ data.id }} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {{ userData.full_name.replace('"', '\"')  }} ({{ userData.user_id }})

ID –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è: {{ data.id }}
–î–∞—Ç–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è: {{ data.date }}
–°—É–º–º–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è: {{ data.bonus }} —Ä—É–±.

{{ IF data.comment.from_user_id }}
<blockquote>{{ data.comment.percent }}% –æ—Ç {{ userData.full_name.replace('"', '\"')  }} ({{ partnerData.user_id }})</blockquote>
{{ END }}

{{ IF data.comment.msg }}
<blockquote>{{ data.comment.msg }}</blockquote>
{{ END }}
{{ END }}

{{ BUTTONS = BLOCK }}
    [
        {
            "text": "‚¨ÖÔ∏è –ù–∞–∑–∞–¥",
            "callback_data": "admin:users:id:bonuses {{ userData.user_id _ ' ' _ offset }}"
        }
    ],
    [
        {
            "text": "üë®‚Äçüíª –ú–µ–Ω—é {{ menuRole = (user.settings.role == 'admin' ? '–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞' : '–º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞'); menuRole; }}",
            "callback_data": "admin:menu"
        },
        {
            "text": "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é",
            "callback_data": "{{ mainMenuCmd }}"
        }
    ]
{{ END }}
{{ send(TEXT=TEXT, BUTTONS=BUTTONS, admin=1) }}


[% CASE ['admin:bonuses:add'] %]
{{ checkModeratorRights(right="addBonus") }}
{{
    userData = user.id(args.0);
}}
{{ TEXT = BLOCK }}
üí∏ –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª-–≤–æ –±–æ–Ω—É—Å–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —Ö–æ—Ç–∏—Ç–µ –Ω–∞—á–∏—Å–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {{ userData.full_name.replace('"', '\"')  }} ({{ userData.user_id }})
–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å –±–æ–Ω—É—Å–æ–≤ {{ userData.get_bonus }} —Ä—É–±.

{{ END }}
{{ BUTTONS = BLOCK }}
    [
        {
            "text": "10 —Ä—É–±",
            "callback_data": "admin:bonuses:add:confirm {{ userData.user_id }} 10"
        },
        {
            "text": "20 —Ä—É–±",
            "callback_data": "admin:bonuses:add:confirm {{ userData.user_id }} 20"
        },
        {
            "text": "30 —Ä—É–±",
            "callback_data": "admin:bonuses:add:confirm {{ userData.user_id }} 30"
        },
        {
            "text": "40 —Ä—É–±",
            "callback_data": "admin:bonuses:add:confirm {{ userData.user_id }} 40"
        }
    ],
    [
        {
            "text": "50 —Ä—É–±",
            "callback_data": "admin:bonuses:add:confirm {{ userData.user_id }} 50"
        },
        {
            "text": "100 —Ä—É–±",
            "callback_data": "admin:bonuses:add:confirm {{ userData.user_id }} 100"
        },
        {
            "text": "150 —Ä—É–±",
            "callback_data": "admin:bonuses:add:confirm {{ userData.user_id }} 150"
        },
        {
            "text": "200 —Ä—É–±",
            "callback_data": "admin:bonuses:add:confirm {{ userData.user_id }} 200"
        }
    ],
    [
        {
            "text": "–£–±—Ä–∞—Ç—å {{ userData.get_bonus }}",
            "callback_data": "admin:bonuses:add:confirm {{ userData.user_id }} -{{ userData.get_bonus }}"
        }
    ],
    [
        {
            "text": "‚¨ÖÔ∏è –ù–∞–∑–∞–¥",
            "callback_data": "admin:users:id:bonuses {{ userData.user_id }}"
        }
    ],
    [
        {
            "text": "üë®‚Äçüíª –ú–µ–Ω—é {{ menuRole = (user.settings.role == 'admin' ? '–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞' : '–º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞'); menuRole; }}",
            "callback_data": "admin:menu"
        },
        {
            "text": "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é",
            "callback_data": "{{ mainMenuCmd }}"
        }
    ]
{{ END }}
{{ send(TEXT=TEXT, BUTTONS=BUTTONS, admin=1) }}


[% CASE ['admin:bonuses:add:confirm'] %]
{{ PROCESS checkAdminRights }}
{{ checkModeratorRights(right="addBonus") }}
{{
    userData = user.id(args.0);
    amount = args.1;
}}

{{ IF amount < 0 }}
    {{ ret = userData.set_bonus('bonus', amount, 'comment', {'msg' => '–†—É—á–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞'}); }}
{{ ELSE }}
    {{ ret = userData.set_bonus('bonus', amount, 'comment', {'msg' => '–†—É—á–Ω–æ–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞'}); }}
    {
        "sendMessage": {
            "chat_id": {{ userData.settings.telegram.chat_id }},
            "text": "üéÅ –í–∞–º –Ω–∞—á–∏—Å–ª–µ–Ω–æ {{ amount }} –±–æ–Ω—É—Å–æ–≤ –Ω–∞ —Å—á–µ—Ç –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞",
            "parse_mode": "HTML",
            "reply_markup": {
                "inline_keyboard": [
                    [
                        {
                            "text": "üë§ –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç",
                            "callback_data": "cabinet"
                        }
                    ]
                ]
            }
        }
    },
{{ END }}

{
    "answerCallbackQuery": {
         "callback_query_id": {{ callback_query.id }},
         "parse_mode":"HTML",
         "text": "–ë–∞–ª–∞–Ω—Å –±–æ–Ω—É—Å–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {{ userData.full_name.replace('"', '\"')  }} ({{ userData.user_id }}) –ø–æ–ø–æ–ª–Ω–µ–Ω –Ω–∞ {{ amount }} —Ä—É–±. –¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å - {{ userData.get_bonus }}",
         "show_alert": true
     }
},
{
    "shmRedirectCallback": {
        "callback_data": "admin:bonuses:add {{ userData.user_id }}"
    }
}


[% CASE ['admin:withdraws:id'] %]
{{
    data = ref(wd.list_for_api('admin', 1, 'filter', {"withdraw_id" = args.0})).first;
    userData = user.id(data.user_id);
}}
{{ TEXT = BLOCK }}
üí∏ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–ø–∏—Å–∞–Ω–∏–∏ ‚Ññ{{ data.withdraw_id }}

–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: {{ userData.full_name.replace('"', '\"')  }} ({{ userData.user_id }})

–£—Å–ª—É–≥–∞: {{ data.name }} ({{ data.user_service_id }})
–°—Ç–æ–∏–º–æ—Å—Ç—å: {{ data.cost }}
–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è: {{ data.create_date }}
–î–∞—Ç–∞ —Å–ø–∏—Å–∞–Ω–∏—è: {{ data.withdraw_date }}
–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–æ —Å–ø–∏—Å–∞–Ω–∏—é: {{ data.end_date }}
–ö–æ–ª-–≤–æ –º–µ—Å—è—Ü–µ–≤: {{ data.months }}

<b>–°–ø–∏—Å–∞–Ω–∏–µ:</b>
<blockquote>
–°–∫–∏–¥–∫–∞: {{ data.discount }}%
–ë–æ–Ω—É—Å–æ–≤: {{ data.bonus }} —Ä—É–±
<b>–í—Å–µ–≥–æ: {{ data.total }}</b>

</blockquote>
{{ END }}

{{ BUTTONS = BLOCK }}
    [
        {
            "text": "‚¨ÖÔ∏è –ù–∞–∑–∞–¥",
            "callback_data": "admin:subs:id {{ data.user_service_id _ ' ' _  userData.user_id }}"
        }
    ],
    [
        {
            "text": "üë®‚Äçüíª –ú–µ–Ω—é {{ menuRole = (user.settings.role == 'admin' ? '–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞' : '–º–æ–¥–µ—Ä–∞—Ç–æ—Ä–∞'); menuRole; }}",
            "callback_data": "admin:menu"
        },
        {
            "text": "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é",
            "callback_data": "{{ mainMenuCmd }}"
        }
    ]
{{ END }}
{{ send(TEXT=TEXT, BUTTONS=BUTTONS, admin=1) }}

[%# ########################################################################################### %]
[%# ############################### ADMIN PANEL END ########################################### %]
[%# ########################################################################################### %]


[%#
    –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –∫–ª—é—á–∞
%]
[% CASE ['notification:create'] %]
{{
    USE date;
    usi = args.0;
    service = user.services.list_for_api('usi', usi);
}}
{{ TEXT = BLOCK }}
‚úÖ <b>–ö–ª—é—á #{{ service.user_service_id }} - {{ service.name }} –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω</b>

üóìÔ∏è <b>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</b>: {{ date.format(service.expire, '%d.%m.%Y') }}

<blockquote><b>–î–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –Ω–∞–∂–º–∏—Ç–µ üîê –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</b></blockquote>
{{ END }}

{{ BUTTONS = BLOCK }}
    [
        {
            "text": "üîê –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è",
            "callback_data": "user:keys:id {{ service.user_service_id }}"
        }
    ],
    [
        {
            "text": "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é",
            "callback_data": "{{ mainMenuCmd }}"
        }
    ]
{{ END }}
{{ notification(TEXT=TEXT, BUTTONS=BUTTONS) }}

[%#
    –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∫–ª—é—á–∞
%]
[% CASE ['notification:block'] %]
{{
    USE date;
    usi = args.0;
    service = user.services.list_for_api('usi', usi);
}}
{{ TEXT = BLOCK }}
‚≠ïÔ∏è <b>–ö–ª—é—á #{{ service.user_service_id }} - {{ service.name }} –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</b>
{{ END }}

{{ BUTTONS = BLOCK }}
    [
        {
            "text": "üîë –ú–æ–∏ –∫–ª—é—á–∏",
            "callback_data": "user:keys"
        }
    ],
    [
        {
            "text": "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é",
            "callback_data": "{{ mainMenuCmd }}"
        }
    ]
{{ END }}
{{ notification(TEXT=TEXT, BUTTONS=BUTTONS) }}



[%#
    –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∫–ª—é—á–∞
%]
[% CASE ['notification:activate'] %]
{{
    USE date;
    usi = args.0;
    service = user.services.list_for_api('usi', usi);
}}
{{ TEXT = BLOCK }}
‚úÖ <b>–ö–ª—é—á #{{ service.user_service_id }} - {{ service.name }} –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω</b>

üóìÔ∏è <b>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</b>: {{ date.format(service.expire, '%d.%m.%Y') }}

<blockquote>–î–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –Ω–∞–∂–º–∏—Ç–µ üîê –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</blockquote>
{{ END }}

{{ BUTTONS = BLOCK }}
    [
        {
            "text": "üîê –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è",
            "callback_data": "user:keys:id {{ service.user_service_id }}"
        }
    ],
    [
        {
            "text": "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é",
            "callback_data": "{{ mainMenuCmd }}"
        }
    ]
{{ END }}
{{ notification(TEXT=TEXT, BUTTONS=BUTTONS) }}

[%#
    –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø—Ä–æ–¥–ª–µ–Ω–∏—è –∫–ª—é—á–∞
%]
[% CASE ['notification:prolongate'] %]
{{
    USE date;
    usi = args.0;
    service = user.services.list_for_api('usi', usi);
}}
{{ TEXT = BLOCK }}
‚úÖ <b>–ö–ª—é—á #{{ service.user_service_id }} - {{ service.name }} –ø—Ä–æ–¥–ª—ë–Ω!</b>

üóìÔ∏è –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è: {{ date.format(service.expire, '%d.%m.%Y') }}

<blockquote>–î–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –Ω–∞–∂–º–∏—Ç–µ üîê –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</blockquote>
{{ END }}

{{ BUTTONS = BLOCK }}
    [
        {
            "text": "üîê –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è",
            "callback_data": "user:keys:id {{ service.user_service_id }}"
        }
    ],
    [
        {
            "text": "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é",
            "callback_data": "{{ mainMenuCmd }}"
        }
    ]
{{ END }}
{{ notification(TEXT=TEXT, BUTTONS=BUTTONS) }}

[%#
    –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ FORECAST
%]
[% CASE ['notification:forecast'] %]
{{
    USE date;
    usi = args.0;
    service = user.services.list_for_api('usi', usi);
    cost = user.pays.forecast('blocked', 1).total;
}}
{{ TEXT = BLOCK }}
üí∞ <b>–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –æ–ø–ª–∞—Ç–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ –∫–ª—é—á–∏</b>

    {{ FOR item in ref(user.pays.forecast.items('blocked', 1)) }}
<code>
üîë #<b>{{ item.user_service_id }} - {{ item.name }}</b>
        {{ IF item.expire }}
üóìÔ∏è <b>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</b>: {{ date.format(item.expire, '%d.%m.%Y') }}
        {{ END }}
</code>
    {{ END }}

<b>–ë–∞–ª–∞–Ω—Å</b>: {{ user.balance }} —Ä—É–±.
<b>–ë–∞–ª–∞–Ω—Å –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–ø–æ–ª–Ω–∏—Ç—å –Ω–∞ </b>{{ cost }} —Ä—É–±.
{{ END }}

{{ BUTTONS = BLOCK }}
    [
        {
            "text": "‚ûï –ü–æ–ø–æ–ª–Ω–∏—Ç—å {{ cost }} —Ä—É–±.",
            "web_app": {
                "url": "{{ config.api.url }}/shm/v1/public/tg_payment?format=html"
            }
        }
    ],
    [
        {
            "text": "üîë –ú–æ–∏ –∫–ª—é—á–∏",
            "callback_data": "user:keys"
        }
    ]
{{ END }}
{{ notification(TEXT=TEXT, BUTTONS=BUTTONS) }}


[%#
    –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–∏ –Ω–µ—Ö–≤–∞—Ç–∫–µ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ
%]
[% CASE ['notification:not_enough_money'] %]
{{
    cost = user.pays.forecast('blocked',1).total;
}}
{{ TEXT = BLOCK }}
‚ÑπÔ∏è <b>–î–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —Å–ª–µ–¥—É—é—â–∏—Ö –∫–ª—é—á–µ–π</b>

    {{ FOR item in ref(user.pays.forecast.items) }}
    {{ # NEXT IF item.status != 'NOT PAID'# }}
<code>üîë #<b>{{ item.user_service_id }} - {{ item.name }}</b></code>
    {{ END }}

<b>–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –æ–ø–ª–∞—Ç–∏—Ç—å </b>{{ cost }} —Ä—É–±.
{{ END }}

{{ BUTTONS = BLOCK }}
    [
        {
            "text": "‚ûï –ü–æ–ø–æ–ª–Ω–∏—Ç—å {{ cost }} —Ä—É–±.",
            "web_app": {
                "url": "{{ config.api.url }}/shm/v1/public/tg_payment?format=html"
            }
        }
    ],
    [
        {
            "text": "üîë –ú–æ–∏ –∫–ª—é—á–∏",
            "callback_data": "user:keys"
        }
    ]
{{ END }}
{{ notification(TEXT=TEXT, BUTTONS=BUTTONS) }}


[%#
    –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è
%]
[% CASE ['notification:payment'] %]
{{ amount = user.pays.last.money }}
{{ total = user.balance }}
{{
    amount = user.pays.last.money;
}}
{{ TEXT = BLOCK }}
‚úÖ <b>–ü–ª–∞—Ç—ë–∂ –Ω–∞ —Å—É–º–º—É {{ amount }} —Ä—É–±. –∑–∞—á–∏—Å–ª–µ–Ω –Ω–∞ –≤–∞—à –±–∞–ª–∞–Ω—Å.</b>

üí∞ <b>–ë–∞–ª–∞–Ω—Å</b>: {{ user.balance }}
{{ END }}

{{ BUTTONS = BLOCK }}
    [
        {
            "text": "üë§ –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç",
            "callback_data": "user:cabinet"
        }
    ],
    [
        {
            "text": "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é",
            "callback_data": "{{ mainMenuCmd }}"
        }
    ]
{{ END }}
{{ notification(TEXT=TEXT, BUTTONS=BUTTONS) }}


[%#
    –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ–º–æ–∫–æ–¥–∞
%]
[% CASE ['notification:promo'] %]

{{ TEXT = BLOCK }}
‚úÖ <b>–ü—Ä–æ–º–æ–∫–æ–¥ {{ args.0 }} —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω—ë–Ω!</b>
{{ END }}

{{ BUTTONS = BLOCK }}
    [
        {
            "text": "üë§ –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç",
            "callback_data": "user:cabinet"
        }
    ],
    [
        {
            "text": "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é",
            "callback_data": "{{ mainMenuCmd }}"
        }
    ]
{{ END }}
{{ notification(TEXT=TEXT, BUTTONS=BUTTONS) }}


[%#
    –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø—Ä–æ–º–æ–∫–æ–¥–∞
%]
[% CASE ['promocode'] %]
{{
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
    ret = user.set_settings({'state' => 'awaiting_promocode'});
    IF user.settings.bot.reqPromo;
        temp = user.settings.bot.reqPromo + 1;
        delete(msgID=[temp, user.settings.bot.reqPromo, message.message_id]);
        ret = user.set_settings({'bot' => {'reqPromo' => message.message_id} });
    ELSE;
        ret = user.set_settings({'bot' => {'reqPromo' => message.message_id} });
    END;
}}
{{ TEXT = BLOCK }}
üí¨ <b>–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –ø—Ä–æ–º–æ–∫–æ–¥:</b>
{{ END }}

{{ notification(TEXT=TEXT, force=1) }}


[% CASE DEFAULT %]


{{ IF user.settings.state == 'awaiting_promocode' }}
{{
    IF user.settings.bot.reqPromo;
        temp = user.settings.bot.reqPromo + 1;
        temp2 = user.settings.bot.reqPromo - 1;
        delete(msgID=[temp, temp2, user.settings.bot.reqPromo, message.message_id]);
        ret = user.set_settings({'bot' => {'reqPromo' => message.message_id} });
    END;

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤–≤–µ–¥–µ–Ω–æ
    IF message.text.match('^[a-zA-Z0-9_-]+$');
        promocode = message.text;
        ret = user.set_settings({'state' => ''});
        
        IF promo.apply(promocode);
            TEXT = "‚úÖ <b>–ü—Ä–æ–º–æ–∫–æ–¥ $promocode –ø—Ä–∏–º–µ–Ω—ë–Ω!</b>";
        ELSE;
            TEXT = "‚≠ïÔ∏è <b>–ü—Ä–æ–º–æ–∫–æ–¥ $promocode –Ω–µ –Ω–∞–π–¥–µ–Ω!</b>";
        END;

    ELSE;
        TEXT = "‚ùå <b>–û—à–∏–±–∫–∞:</b> –ü—Ä–æ–º–æ–∫–æ–¥ –º–æ–∂–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã, —Ç–∏—Ä–µ (-) –∏ –Ω–∏–∂–Ω–µ–µ –ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏–µ (_).";
    END;
}}

{{ BUTTONS = BLOCK }}
    [
        {
            "text": "üè∑Ô∏è –í–≤–µ—Å—Ç–∏ –µ—â—ë",
            "callback_data": "promocode"
        }
    ],
    [
        {
            "text": "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é",
            "callback_data": "{{ mainMenuCmd }}"
        }
    ]
{{ END }}
{{ notification(TEXT=TEXT, BUTTONS=BUTTONS) }}


{{ ELSIF user.settings.state == 'awaiting_amount' AND user.settings.bot.switchUser }}
    {{
        userData = user.id(user.settings.bot.switchUser);
        IF message.text.match('^-?\d+(\.\d+)?$');
            amount = message.text;

            IF (ret = userData.payment('money', amount, 'pay_system_id', 'manual'));
                TEXT = "‚úÖ <b>–ë–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è $userData.user_id –ø–æ–ø–æ–ª–Ω–µ–Ω –Ω–∞ $amount —Ä—É–±.</b>\n–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: $userData.balance —Ä—É–±.";
            ELSE;
                TEXT = "‚≠ïÔ∏è –û—à–∏–±–∫–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É.";
            END;

            ret = user.set_settings({'state' => ''});
            ret = user.set_settings({'bot' => {'switchUser' => ''} });
        ELSE;
            TEXT = "‚≠ïÔ∏è –û—à–∏–±–∫–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É.";
        END;
    }}
{{ BUTTONS = BLOCK }}
[
    {
        "text": "‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ",
        "callback_data": "admin:users:id {{ userData.user_id }}"
    }
],
[
    {
        "text": "üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é",
        "callback_data": "{{ mainMenuCmd }}"
    }
]
{{ END }}
{{ notification(TEXT=TEXT, BUTTONS=BUTTONS) }}
{{ ELSE }}
    {{ 
        ret = user.set_settings({'bot' => {'switchUser' => ''} });
        ret = user.set_settings({'state' => ''});
    }}
{
    "deleteMessage": { "message_id": {{ message.message_id }} }
}
{{ END }}
[% END %]
